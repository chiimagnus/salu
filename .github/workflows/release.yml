name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  # ============================================================
  # macOS æ„å»ºï¼ˆå‘½ä»¤è¡Œ + .app æ†ç»‘åŒ…ï¼‰
  # ============================================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥æ”¯æŒ git describe

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'

      - name: Build release binary
        run: swift build -c release

      - name: Run all Swift tests
        run: swift test

      - name: Create release artifacts
        run: |
          mkdir -p artifact
          
          # è·å–ç‰ˆæœ¬å·
          VERSION="${GITHUB_REF_NAME:-$(git describe --tags --abbrev=0 2>/dev/null || echo "1.0.0")}"
          VERSION="${VERSION#v}"
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          
          # 1. å‘½ä»¤è¡ŒäºŒè¿›åˆ¶ (tar.gz)
          cp .build/release/GameCLI artifact/salu-macos
          chmod +x artifact/salu-macos
          cd artifact
          tar -czf salu-macos.tar.gz salu-macos
          rm salu-macos
          cd ..
          
          # 2. åˆ›å»º macOS .app æ†ç»‘åŒ…
          APP_NAME="Salu"
          BUNDLE_ID="com.salu.game"
          APP_BUNDLE="artifact/${APP_NAME}.app"
          
          mkdir -p "${APP_BUNDLE}/Contents/MacOS"
          mkdir -p "${APP_BUNDLE}/Contents/Resources"
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          cp .build/release/GameCLI "${APP_BUNDLE}/Contents/MacOS/salu-bin"
          chmod +x "${APP_BUNDLE}/Contents/MacOS/salu-bin"
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > "${APP_BUNDLE}/Contents/MacOS/${APP_NAME}" << 'LAUNCHER_EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          BINARY="$SCRIPT_DIR/salu-bin"
          if [ -t 0 ] && [ -t 1 ]; then
              exec "$BINARY" "$@"
          else
              osascript <<EOF
          tell application "Terminal"
              activate
              do script "clear && '$BINARY' ; echo '' ; echo 'æŒ‰ä»»æ„é”®å…³é—­çª—å£...' ; read -n 1 ; exit"
          end tell
          EOF
          fi
          LAUNCHER_EOF
          chmod +x "${APP_BUNDLE}/Contents/MacOS/${APP_NAME}"
          
          # åˆ›å»º Info.plist
          cat > "${APP_BUNDLE}/Contents/Info.plist" << PLIST_EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>${APP_NAME}</string>
              <key>CFBundleIdentifier</key>
              <string>${BUNDLE_ID}</string>
              <key>CFBundleName</key>
              <string>${APP_NAME}</string>
              <key>CFBundleDisplayName</key>
              <string>Salu - ç»ˆç«¯å†’é™©æ¸¸æˆ</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleSignature</key>
              <string>????</string>
              <key>LSMinimumSystemVersion</key>
              <string>14.0</string>
              <key>NSHumanReadableCopyright</key>
              <string>Copyright Â© 2026 Salu Team. All rights reserved.</string>
              <key>LSApplicationCategoryType</key>
              <string>public.app-category.games</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          PLIST_EOF
          
          # åˆ›å»º PkgInfo
          echo -n "APPL????" > "${APP_BUNDLE}/Contents/PkgInfo"
          
          # åˆ›å»º zip å‹ç¼©åŒ…
          cd artifact
          ditto -c -k --keepParent "${APP_NAME}.app" "Salu-macos-${VERSION}.zip"
          rm -rf "${APP_NAME}.app"
          cd ..
          
          echo "ğŸ“ äº§ç‰©åˆ—è¡¨:"
          ls -lh artifact/

      - name: Upload macOS CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: salu-macos-cli
          path: artifact/salu-macos.tar.gz
          retention-days: 90

      - name: Upload macOS App artifact
        uses: actions/upload-artifact@v4
        with:
          name: salu-macos-app
          path: artifact/Salu-macos-*.zip
          retention-days: 90

  # ============================================================
  # Linux æ„å»ºï¼ˆx86_64 Ubuntu 22.04ï¼‰
  # ============================================================
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'

      - name: Build release binary
        run: swift build -c release

      - name: Run all Swift tests
        run: swift test

      - name: Create release artifact
        run: |
          mkdir -p artifact
          cp .build/release/GameCLI artifact/salu-linux-x86_64
          chmod +x artifact/salu-linux-x86_64
          cd artifact
          tar -czf salu-linux-x86_64.tar.gz salu-linux-x86_64
          rm salu-linux-x86_64
          
          echo "ğŸ“ äº§ç‰©åˆ—è¡¨:"
          ls -lh .

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: salu-linux-x86_64
          path: artifact/salu-linux-x86_64.tar.gz
          retention-days: 90

  # ============================================================
  # åˆ›å»º GitHub Releaseï¼ˆå‘å¸ƒæ‰€æœ‰å¹³å°äº§ç‰©ï¼‰
  # ============================================================
  create-release:
    name: Create Release
    needs: [build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download macOS CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: salu-macos-cli
          path: release-artifacts

      - name: Download macOS App artifact
        uses: actions/download-artifact@v4
        with:
          name: salu-macos-app
          path: release-artifacts

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: salu-linux-x86_64
          path: release-artifacts

      - name: List artifacts
        run: ls -la release-artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-artifacts/salu-macos.tar.gz
            release-artifacts/Salu-macos-*.zip
            release-artifacts/salu-linux-x86_64.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ä¸‹è½½æŒ‡å—
            
            ### macOS
            - **æ¨è**: `Salu-macos-*.zip` - åŒå‡»å³å¯è¿è¡Œçš„ .app åº”ç”¨
            - å‘½ä»¤è¡Œ: `salu-macos.tar.gz` - è§£å‹ååœ¨ç»ˆç«¯è¿è¡Œ `./salu-macos`
            
            ### Linux (Ubuntu 22.04+)
            - `salu-linux-x86_64.tar.gz` - è§£å‹ååœ¨ç»ˆç«¯è¿è¡Œ `./salu-linux-x86_64`
            
            ---
            
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
