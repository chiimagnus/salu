# P6：多敌人战斗 + 目标选择（Plan A）- 2026-01-05

> 目标：让战斗引擎支持 **多个敌人同场**；卡牌/状态/敌人 AI 通过统一 Effect 管线支持 **指定目标**；CLI 支持输入 `卡牌序号 目标序号` 选择目标。  
> 验收：至少 2 个敌人同场战斗可正常结算；可指定目标并只影响该目标；全量 `swift test` 通过；`swift build -c release` 通过。

---

## 设计基线（来自当前代码的事实）

- 现状“单敌人假设”集中在：
  - `Sources/GameCore/Kernel/BattleEffect.swift`：`EffectTarget` 只有 `.player/.enemy`
  - `Sources/GameCore/Battle/BattleState.swift`：只有 `enemy: Entity`
  - `Sources/GameCore/Cards/CardDefinition.swift`：`BattleSnapshot` 只有 `enemy: Entity`
  - `Sources/GameCore/Battle/BattleEngine.swift`：伤害/格挡/状态/意图/胜负判定都写死单敌人
  - `Sources/GameCLI/GameCLI.swift`：战斗输入只接受一个数字（出牌/结束回合）
  - `Sources/GameCLI/Screens/BattleScreen.swift`：只渲染一个敌人区域

- 约束：
  - `GameCore` 必须保持纯逻辑（无 `print`/stdin/UI；避免 `Foundation`）
  - 仍保持 PDD（Definition + Registry + Effect 管线），不要在 `BattleEngine` 新增内容扩展型 switch
  - 可复现性：随机依旧来自注入的 `SeededRNG`
  - `GameCLI` 所有用户可见文本为中文，颜色/清屏遵循 `Terminal`

---

## Plan A（分优先级推进）

### P1：统一“实体引用”模型（目标可表达多敌人）

**状态（已执行）**
- ✅ 完成（2026-01-06）
- ✅ 验证：`swift test` 通过

**目标**
- 让所有 Effect 能表达“第 N 个敌人”作为目标；为后续把“伤害来源/目标”显式化铺路。

**改动点**
- `Sources/GameCore/Kernel/BattleEffect.swift`
  - 扩展 `EffectTarget`：支持 `.enemy(index: Int)`（多敌人实例）
  - 调整 `BattleEffect.dealDamage`：由“只有 target”升级为“source + target”（多敌人时必须明确伤害来源）
- `Sources/GameCore/Status/StatusDefinition.swift`
  - `onTurnEnd(owner: ...)` 的 owner 改为新 `EffectTarget`（可携带 enemy index）
- `Sources/GameCore/Relics/*` / `Enemies/*` / `Cards/*`
  - 全部编译修复：把旧 `.enemy` 迁移到新表达（先用占位索引，后续 P2/P3 再补齐上下文）

**验收**
- 工程可编译（此阶段允许测试未过，优先完成类型迁移以解锁后续改造）

**验证**
- `swift test`（允许失败，但要记录失败点，P2/P3 修复）

---

### P2：BattleState/BattleEngine 改造为多敌人回合管线

**状态（已执行）**
- ✅ 完成（2026-01-06）
- ✅ 验证：`swift test` 通过

**目标**
- `BattleState` 存储多个敌人；`BattleEngine` 支持：
  - 玩家出牌可命中指定敌人
  - 玩家回合结束后，多个敌人按顺序执行意图
  - 状态触发与递减按“实体自己的回合结束”结算
  - 胜利条件：所有敌人死亡；失败条件：玩家死亡

**改动点**
- `Sources/GameCore/Battle/BattleState.swift`
  - `enemy: Entity` → `enemies: [Entity]`
  - 提供轻量工具：`aliveEnemyIndices`、`isAllEnemiesDefeated` 等（避免散落判断）
- `Sources/GameCore/Battle/BattleEngine.swift`
  - `decideEnemyIntent()`：对每个存活敌人决定 `plannedMove`
  - `executeEnemyTurn()`：按索引顺序执行每个敌人的 `plannedMove`（敌人死亡则跳过）
  - `apply(_:)`：适配新版 `dealDamage(source:target:)` 与 `.enemy(index:)` 的实体解析
  - `processStatusesAtTurnEnd(for:)`：支持 `.enemy(index:)`
  - `checkBattleEnd()`：改为“全部敌人死亡才胜利”

**验收**
- 纯 GameCore 逻辑已可跑通：手动构造 2 敌人的 BattleEngine，可以完成一个回合并正确推进。

**验证**
- `swift test`（此阶段目标：大多数 GameCoreTests 已恢复通过）

---

### P3：CardDefinition / EnemyDefinition 的“目标选择”接口落地

**状态（已执行）**
- ✅ 完成（2026-01-06）
- ✅ 验证：`swift test` 通过

**目标**
- 卡牌出牌支持“需要目标的卡牌必须提供目标”；敌人 AI 支持“自我引用”为 `.enemy(index:)`。

**改动点**
- `Sources/GameCore/Actions.swift`
  - `PlayerAction.playCard` 增加 `targetEnemyIndex: Int?`
- `Sources/GameCore/Cards/CardDefinition.swift`
  - `BattleSnapshot` 迁移为 `player + enemies + energy + turn`
  - `CardDefinition.play(...)` 接口增加 `targetEnemyIndex: Int?`
  - 新增 `CardTargeting`（默认：攻击牌需要单体敌人目标；技能/能力不需要）
- `Sources/GameCore/Cards/Definitions/Ironclad/*`
  - 所有攻击牌改为使用 `targetEnemyIndex` 生成 `.enemy(index:)` 目标
- `Sources/GameCore/Enemies/EnemyDefinition.swift` + `Enemies/Definitions/*`
  - `chooseMove` 增加 `selfIndex`（用于把“对敌人自身施加力量”等效果，落到对应 `.enemy(index:)`）
- `Sources/GameCore/Status/Definitions/Debuffs.swift`（Poison）
  - 更新 poison 在新签名下的效果产出

**验收**
- GameCore：指定目标时，只影响被选敌人；不提供目标时，对需要目标的卡牌返回 `invalidAction`。

**验证**
- `swift test`

---

### P4：EnemyEncounter 生成与 CLI 战斗输入协议升级

**状态（已执行）**
- ✅ 完成（2026-01-06）
- ✅ 验证：`swift test` 通过

**目标**
- 让实际游戏流程能进入“2 个敌人同场”的战斗；CLI 支持目标输入。

**改动点**
- `Sources/GameCore/Enemies/*`
  - 新增 `EnemyEncounter` / `Act1EncounterPool`：从单个 `EnemyID` 扩展为 `[EnemyID]`（可复现）
  - `createEnemy` 支持实例序号，确保同类敌人同场时可区分
- `Sources/GameCLI/Rooms/Handlers/*.swift`
  - Battle/Elite/Boss 初始化 BattleEngine 改为传入敌人数组（普通战斗至少提供一种 2 敌人遭遇）
- `Sources/GameCLI/Screens/BattleScreen.swift`
  - 渲染敌人区域为列表，并显示目标序号（例如 `[1]` `[2]`）
  - 操作提示更新：出牌提示改为 `卡牌序号 目标序号`
- `Sources/GameCLI/GameCLI.swift`
  - 战斗输入解析：支持 `"<cardIndex> <targetIndex>"`；并对不合法目标给出中文错误提示

**验收**
- 实机 `swift run GameCLI --seed 1` 可遇到 2 敌人战斗并能选目标击杀其中一个，战斗继续直到全部敌人死亡。

**验证**
- `swift test`

---

### P5：战绩/记录结构适配多敌人

**状态（已执行）**
- ✅ 完成（2026-01-06）
- ✅ 验证：`swift test` 通过

**目标**
- 战斗记录不再假设“只有一个敌人”，避免编译与数据语义错误。

**改动点**
- `Sources/GameCore/History.swift`
  - `BattleRecord`：把 `enemyName/enemyMaxHP/enemyFinalHP` 替换为 `enemies: [EnemyBattleRecord]`（含 name/maxHP/finalHP）
  - `BattleRecordBuilder`：从 `BattleEngine.state.enemies` 构建记录
- `Sources/GameCLI/Persistence/FileBattleHistoryStore.swift`
  - JSON 读写跟随新结构（不做旧版本兼容）

**验收**
- UI 的历史/统计界面仍可正常打开；新增记录可成功写入并读取。

**验证**
- `swift test`

---

### P6：补齐与加固测试覆盖（多敌人 + 目标选择）

**状态（已执行）**
- ✅ 完成（2026-01-06）
- ✅ 验证：`swift test` / `swift build -c release` 通过

**目标**
- 更新所有受影响测试；新增回归测试确保 P6 不会回退。

**新增/更新测试方向**
- `Tests/GameCoreTests/*`
  - 新增：两敌同场时，`PlayerAction.playCard(..., targetEnemyIndex:)` 只影响目标敌人
  - 新增：击杀一个敌人后战斗不结束；全部击杀后胜利
  - 更新：EnemyDeterminismTests / StatusDefinitionTests / BattleEngineFlowTests 等签名迁移
- `Tests/GameCLIUITests/*`
  - 更新：测试模式下出牌输入改为 `1 1`（或对不需要目标的卡维持单数字）

**验收**
- `swift test` 全绿
- `swift build -c release` 通过

**验证**
- `swift test`
- `swift build -c release`


