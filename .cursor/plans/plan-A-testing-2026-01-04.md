# Plan Aï¼šç”¨ Swift XCTest æ›¿ä»£ sh è„šæœ¬æµ‹è¯•ï¼ˆå•å…ƒæµ‹è¯• + CLIã€ŒUIã€æµ‹è¯•ï¼‰- 2026-01-04

> ç›®æ ‡ï¼šå½»åº•è§£å†³â€œè„šæœ¬è·‘è¿‡ä½†å†…éƒ¨é€»è¾‘æœªå®ç°ä¹Ÿå¯èƒ½ç»¿â€çš„é—®é¢˜ã€‚  
> æ–¹æ¡ˆï¼šæŠŠç°æœ‰ `.cursor/Scripts/tests/test_*.sh` çš„è¦†ç›–é¢è¿ç§»ä¸º **Swift XCTest**ï¼š  
> - **å•å…ƒæµ‹è¯•ï¼ˆUnitï¼‰**ï¼šç›´æ¥æ–­è¨€ GameCore å†…éƒ¨é€»è¾‘ï¼ˆçº¯é€»è¾‘ã€å¯å¤ç°ã€å¼ºæ–­è¨€ï¼‰ã€‚  
> - **CLIã€ŒUIã€æµ‹è¯•ï¼ˆE2E/Black-boxï¼‰**ï¼šç”¨ `Process` å¯åŠ¨ `GameCLI`ï¼Œé€šè¿‡ stdin é©±åŠ¨æµç¨‹ï¼Œæ–­è¨€ stdout å…³é”®é”šç‚¹ + å­˜æ¡£/æˆ˜ç»©æ–‡ä»¶å‰¯ä½œç”¨ã€‚

---

## 0. ç°çŠ¶åŸºçº¿ï¼ˆåŸºäºå½“å‰ä»£ç ï¼‰

### 0.1 å·²æœ‰çš„ Swift å•å…ƒæµ‹è¯•ï¼ˆâœ…ï¼‰

- ç›®å½•ï¼š`Tests/GameCoreTests/`
- ç‰¹ç‚¹ï¼š
  - å·²ç»æœ‰æ˜ç¡®çš„ä¸­æ–‡ doc commentï¼ˆâ€œç›®çš„/è§„åˆ™/ç¡®å®šæ€§â€ï¼‰
  - è¦†ç›–äº†ï¼šä¼¤å®³/æ ¼æŒ¡ä¿®æ­£é¡ºåºã€æ•Œäºº determinismã€åœ°å›¾ç”Ÿæˆçº¦æŸã€æ³¨å†Œè¡¨å†’çƒŸã€é—ç‰©é›†æˆã€å¥–åŠ±ç”Ÿæˆã€RunSnapshot JSONã€deck å®ä¾‹ IDã€çŠ¶æ€å®¹å™¨ä¸çŠ¶æ€å®šä¹‰

### 0.2 ç°æœ‰çš„ sh è„šæœ¬æµ‹è¯•ï¼ˆâš ï¸ æ˜“â€œå‡ç»¿â€ï¼‰

- å…¥å£ï¼š`.cursor/Scripts/test_game.sh`
- å¥—ä»¶ï¼š`.cursor/Scripts/tests/test_{startup,enemy,map,save,reward,integration,relic,build,unit}.sh`
- ä¸»è¦é—®é¢˜ï¼š
  - å¾ˆå¤šæ£€æŸ¥æ˜¯ã€Œè·‘ GameCLI + grep è¾“å‡ºã€æˆ–ã€Œæ£€æŸ¥æ–‡ä»¶å­˜åœ¨ã€ï¼Œå¯¹â€œå†…éƒ¨é€»è¾‘åˆ†æ”¯æ˜¯å¦æ­£ç¡®â€ç¼ºå°‘å¼ºæ–­è¨€
  - ä½¿ç”¨ `pkill`ã€`grep` ç­‰å¤–éƒ¨è¡Œä¸ºä¼šè®©æµ‹è¯•è¯­ä¹‰å˜å¾—æ¨¡ç³Šï¼ˆå°¤å…¶åœ¨ CI / ä¸åŒ OS ä¸Šï¼‰

### 0.3 CI ç°çŠ¶

- ç›®å‰ CIï¼š`.github/workflows/test.yml` è¿è¡Œ `./.cursor/Scripts/test_game.sh all`  
- ä½ æœŸæœ›ï¼šCI æ¯æ¬¡è·‘ **Swift XCTest çš„å…¨é‡æµ‹è¯•**ï¼ˆä¸å†ä»¥ sh ä½œä¸ºæµ‹è¯•å®ç°ï¼‰ã€‚

---

## 1. æµ‹è¯•åˆ†å±‚ä¸å‘½åï¼ˆç»Ÿä¸€å£å¾„ï¼‰

### 1.1 Unitï¼ˆå•å…ƒæµ‹è¯•ï¼‰

**èŒè´£**ï¼šéªŒè¯ GameCore é‡Œâ€œå†…éƒ¨é€»è¾‘ç¡®å®å®ç°â€ï¼Œä¸ä¾èµ– CLI è¾“å‡ºã€ä¸ä¾èµ–æ–‡ä»¶ç³»ç»Ÿï¼ˆé™¤ `RunSnapshotCodableTests` è¿™ç±»æ˜ç¡®æµ‹è¯• Codable çš„åœºæ™¯ï¼‰ã€‚

**ä½ç½®**ï¼šç»§ç»­æ”¾åœ¨ `Tests/GameCoreTests/`ï¼ŒæŒ‰é¢†åŸŸæ‹†åˆ†æ–‡ä»¶ï¼ˆBattle/Run/Map/Rewards/Relics/Statusâ€¦ï¼‰ã€‚

### 1.2 CLI UI Testsï¼ˆç»ˆç«¯ UI / E2E æµ‹è¯•ï¼‰

**èŒè´£**ï¼šéªŒè¯â€œä»ç”¨æˆ·è§’åº¦çœŸå®å¯ç©â€çš„å…³é”®æµç¨‹æ²¡æœ‰æ–­é“¾ï¼š

- ä¸»èœå•èƒ½å¯åŠ¨å¹¶é€€å‡ºï¼ˆä¸æŒ‚æ­»ï¼‰
- æ–°å†’é™© â†’ åœ°å›¾ â†’ è¿›å…¥æˆ˜æ–— â†’ é€€å‡ºåˆ°ä¸»èœå•ï¼ˆä¸æŒ‚æ­»ï¼‰
- å­˜æ¡£åˆ›å»ºä¸ç»§ç»­å†’é™©ï¼ˆæ–‡ä»¶å‰¯ä½œç”¨ + æç¤ºæ–‡æ¡ˆï¼‰
- æˆ˜æ–—èƒœåˆ©åå¥–åŠ±ç•Œé¢å‡ºç°ï¼Œå¹¶ä¸”é€‰æ‹©å deck å˜åŒ–èƒ½è¿›å…¥å­˜æ¡£
- æˆ˜ç»©æ–‡ä»¶å†™å…¥ï¼ˆbattle_history.json è¿½åŠ è®°å½•ï¼‰

**å®ç°æ–¹å¼**ï¼šSwift XCTest å†…ä½¿ç”¨ `Foundation.Process`ï¼š

- `stdin`ï¼šå†™å…¥æ¨¡æ‹Ÿè¾“å…¥ï¼ˆå¤šè¡Œå­—ç¬¦ä¸²ï¼‰
- `stdout/stderr`ï¼šç”¨ `Pipe` æ•è·
- `SALU_DATA_DIR`ï¼šæŒ‡å‘ä¸´æ—¶ç›®å½•ï¼Œéš”ç¦»æµ‹è¯•æ•°æ®ï¼ˆä¸ç°æœ‰å®ç°ä¸€è‡´ï¼‰
- **è¶…æ—¶**ï¼šæ¯ä¸ªè¿›ç¨‹æµ‹è¯•å¿…é¡»æœ‰ timeoutï¼Œè¶…æ—¶å°± kill å¹¶ failï¼ˆé˜²æ­¢å¡æ­»ï¼‰
- **ANSI å»é™¤**ï¼šæ–­è¨€å‰å»ºè®® strip ANSI color codeï¼Œé¿å…ç¯å¢ƒå·®å¼‚

---

## 2. P1ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ï¼šå»ºç«‹ Swiftã€ŒCLI UI Testã€æµ‹è¯•åŸºå»º + CI è·‘ `swift test`

### 2.1 æ–°å¢æµ‹è¯• Targetï¼ˆå»ºè®®ï¼‰

åœ¨ `Package.swift` æ–°å¢ä¸€ä¸ªæµ‹è¯• targetï¼ˆå‘½åç¤ºä¾‹ï¼‰ï¼š

- `GameCLIUITests`
  - åªä¾èµ– `GameCore`ï¼ˆç”¨äºè§£æ `RunSnapshot`/`BattleRecord`ï¼‰ï¼Œä¸ç›´æ¥ `@testable import GameCLI`
  - é€šè¿‡ `Process` è¿è¡Œ `.build/release/GameCLI`ï¼ˆCI å…ˆ buildï¼‰

> è¿™æ ·å¯ä»¥é¿å…æŠŠ `@main` çš„å¯æ‰§è¡Œæ¨¡å—ç›´æ¥ä½œä¸ºæµ‹è¯•ä¾èµ–ï¼ˆå‡å°‘æ½œåœ¨çš„ entrypoint/linking é£é™©ï¼‰ã€‚

### 2.2 æ–°å¢æµ‹è¯•å·¥å…·ï¼ˆTest Supportï¼‰

æ–°å¢ç›®å½•ï¼š`Tests/TestSupport/`ï¼ˆæˆ– `Tests/GameCLIUITests/Support/`ï¼‰

å»ºè®®æä¾›ï¼š

- `TemporaryDirectory`
  - åˆ›å»º/æ¸…ç†ä¸´æ—¶ç›®å½•ï¼ˆæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹ç›®å½•ï¼‰
- `CLIRunner`
  - è¾“å…¥ï¼š`binaryURL`ã€`arguments`ã€`stdin` å­—ç¬¦ä¸²ã€`env`ã€`timeout`
  - è¾“å‡ºï¼š`exitCode`ã€`stdout`ã€`stderr`
  - æ”¯æŒï¼š`stripANSI()`
  - æ”¯æŒï¼šè¶…æ—¶ kill
- `BinaryLocator`
  - ä¼˜å…ˆå¯»æ‰¾ `.build/release/GameCLI`
  - fallback `.build/debug/GameCLI`
  - éƒ½ä¸å­˜åœ¨æ—¶ failï¼Œå¹¶æç¤ºå…ˆ `swift build -c release`

### 2.3 CI æ”¹é€ ï¼ˆä¸å†ç”¨ sh ä½œä¸ºæµ‹è¯•å®ç°ï¼‰

æ”¹ `.github/workflows/test.yml`ï¼š

- **Buildï¼ˆreleaseï¼‰**ï¼š`swift build -c release`
- **Run all tests**ï¼š`swift test`

è¯´æ˜ï¼š

- `swift test` è´Ÿè´£è·‘ **Unit + CLI UI Tests**ï¼ˆSwift å®ç°ï¼‰
- `swift build -c release` è´Ÿè´£ç¡®ä¿ GameCLI release å¯ç¼–è¯‘ï¼Œå¹¶ä¸º UI tests æä¾›å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
- å¦‚æœæƒ³ä¿ç•™äº§ç‰©ä¸Šä¼ ï¼Œå»ºè®®ä¸Šä¼  `.build/release/GameCLI` è€Œä¸æ˜¯ debug

éªŒæ”¶ï¼š

- PR/Push æ¯æ¬¡å¿…è·‘ `swift test` å…¨é‡å¥—ä»¶
- ä¸å†ä¾èµ– `.cursor/Scripts/test_game.sh all`

---

## 3. P2ï¼šæŠŠç°æœ‰ sh åœºæ™¯é€ä¸ªè¿ç§»ä¸º Swift XCTestï¼ˆå¯¹é½ä½ å…³å¿ƒçš„â€œçœŸå®å®ç°â€ï¼‰

### 3.1 å¯¹åº”å…³ç³»ï¼ˆè„šæœ¬ â†’ Swift æµ‹è¯•ï¼‰

| æ—§è„šæœ¬ | Swift æ›¿ä»£ç­–ç•¥ | æ–­è¨€é‡ç‚¹ï¼ˆé¿å…å‡ç»¿ï¼‰ |
|---|---|---|
| `test_startup.sh` | `GameCLIUITests.testMainMenuBootAndExit()` | è¾“å‡ºåŒ…å«ä¸»èœå•å…³é”®å­—ï¼›è¿›ç¨‹æ­£å¸¸é€€å‡º |
| `test_map.sh` | `GameCLIUITests.testEnterRunAndRenderMap()` | è¾“å‡ºåŒ…å«åœ°å›¾æ ‡è¯†ï¼ˆèµ·ç‚¹/Boss/èŠ‚ç‚¹å›¾æ ‡ï¼‰ï¼›ä¸æŒ‚æ­» |
| `test_enemy.sh` | **ä¼˜å…ˆç”¨ç°æœ‰ `EnemyDeterminismTests`**ï¼›å¦‚éœ€ UI è¦†ç›–ï¼šè·‘ä¸€æ¬¡è¿›å…¥æˆ˜æ–— | Unitï¼šdeterminismï¼›UIï¼šæˆ˜æ–—ç•Œé¢å‡ºç° |
| `test_save.sh` | `GameCLIUITests.testSaveCreateAndContinue()` | `run_save.json` åˆ›å»ºï¼›äºŒæ¬¡å¯åŠ¨å‡ºç°â€œå­˜æ¡£åŠ è½½æˆåŠŸï¼â€ |
| `test_reward.sh` | `GameCLIUITests.testBattleRewardAddsCardToDeckAndPersists()` | å¥–åŠ±ç•Œé¢å‡ºç°ï¼›å­˜æ¡£é‡Œ `deck.count` å¢åŠ ï¼›`RunSnapshot` å¯ decode |
| `test_relic.sh` | **ä¼˜å…ˆç”¨ç°æœ‰ `RelicIntegrationTests`**ï¼›å¦‚éœ€ UI è¦†ç›–ï¼šéªŒè¯æŸè§¦å‘å¯¼è‡´å¯è§‚å¯Ÿå‰¯ä½œç”¨ï¼ˆå¦‚èƒ½é‡å˜åŒ–ï¼‰ | Unitï¼šè§¦å‘ç‚¹/æ•ˆæœï¼›UIï¼šè¾“å‡ºé”šç‚¹ +ï¼ˆå¯é€‰ï¼‰å‰¯ä½œç”¨ |
| `test_integration.sh` | `GameCLIUITests.testShortAdventurePathDoesNotHang()` | é‡ç‚¹ï¼šä¸æŒ‚æ­»ï¼›å…³é”®é¡µé¢å‡ºç°ï¼›å¿…è¦æ—¶ç”¨å­˜æ¡£/æˆ˜ç»©æ–‡ä»¶æ–­è¨€ |
| `test_build.sh` | CI step `swift build -c release` | ç¼–è¯‘æ˜¯å¦é€šè¿‡ï¼ˆä¸å±äº XCTest çš„èŒè´£ï¼‰ |
| `test_unit.sh` | `swift test` | å…¨é‡ Unit + UI tests |

### 3.2 CLI UI Tests çš„ã€Œå¼ºæ–­è¨€ã€ä¼˜å…ˆçº§

ä¸ºäº†é¿å…â€œgrep è¾“å‡º=é€šè¿‡â€çš„è€é—®é¢˜ï¼ŒUI tests çš„æ–­è¨€é¡ºåºå»ºè®®ï¼š

1) **æ–‡ä»¶å‰¯ä½œç”¨**ï¼ˆæœ€å¼ºï¼‰ï¼š`run_save.json` / `battle_history.json` å­˜åœ¨ä¸”å¯è¢« `JSONDecoder` è§£ç   
2) **å…³é”®çŠ¶æ€å­—æ®µ**ï¼ˆå¼ºï¼‰ï¼šæ¯”å¦‚ `RunSnapshot.deck.count`ã€`relicIds`ã€`player.currentHP`  
3) **è¾“å‡ºé”šç‚¹**ï¼ˆè¾…åŠ©ï¼‰ï¼šæ¯”å¦‚â€œå­˜æ¡£åŠ è½½æˆåŠŸï¼â€ã€â€œğŸ æˆ˜æ–—å¥–åŠ±â€

---

## 4. P3ï¼šç§»é™¤/é™çº§ sh è„šæœ¬ä¸ºã€Œæœ¬åœ°è¾…åŠ©ã€å¹¶æ›´æ–°æ–‡æ¡£

ä½ å¸Œæœ›â€œä¸å†ç”¨ sh åšæµ‹è¯•å®ç°â€ï¼Œå› æ­¤å»ºè®®ä¸¤æ­¥èµ°ï¼ˆç ´åæ€§æ›´å°ï¼‰ï¼š

### 4.1 ç¬¬ä¸€é˜¶æ®µï¼ˆæ¨èï¼‰

- CI å®Œå…¨åˆ‡æ¢åˆ° `swift build` + `swift test`
- `.cursor/Scripts/*` ä¿ç•™ä½†æ ‡æ³¨ä¸ºâ€œæœ¬åœ°è°ƒè¯•è„šæœ¬ / å·²ä¸ä½œä¸º CI æµ‹è¯•æ¥æºâ€

### 4.2 ç¬¬äºŒé˜¶æ®µï¼ˆæ›´å½»åº•ï¼‰

- åˆ é™¤ `.cursor/Scripts/tests/test_*.sh` ä¸ `test_game.sh`
- README/å¼€å‘è§„èŒƒæ”¹ä¸ºåªä¿ç•™ï¼š
  - `swift test`
  - ï¼ˆå¯é€‰ï¼‰`swift build -c release`

---

## 5. å•å…ƒæµ‹è¯•ä¹¦å†™è§„èŒƒï¼ˆä½ è¦æ±‚â€œå†™æ¸…æ¥šæ¯ä¸ªæµ‹è¯•å¹²å˜›â€ï¼‰

ä»ç°æœ‰ `GameCoreTests` çš„é£æ ¼å»¶ä¼¸ï¼Œæ–°å¢/è¿ç§»æµ‹è¯•ç»Ÿä¸€è¦æ±‚ï¼š

- æ¯ä¸ª `XCTestCase` é¡¶éƒ¨æœ‰ `///` è¯´æ˜ï¼š**ç›®çš„/è¦†ç›–èŒƒå›´/ä¸ºä½•é‡è¦**
- æ¯ä¸ª test æ–¹æ³•éƒ½æœ‰ `///` è¯´æ˜ï¼š**åœºæ™¯ + æœŸæœ› + å¤±è´¥ä»£è¡¨ä»€ä¹ˆå›å½’**
- æ–¹æ³•ä½“ç»“æ„å›ºå®šä¸ºï¼š
  - **Arrange**ï¼šæ„é€ è¾“å…¥/seed/ä¸´æ—¶ç›®å½•
  - **Act**ï¼šè°ƒç”¨å‡½æ•°æˆ–è¿è¡Œ CLI
  - **Assert**ï¼šå¯¹å…³é”®å­—æ®µ/æ–‡ä»¶å‰¯ä½œç”¨/äº‹ä»¶åšæ–­è¨€

---

## 6. éªŒæ”¶æ¸…å•ï¼ˆå®Œæˆ P1~P3 åä½ èƒ½å¾—åˆ°ä»€ä¹ˆï¼‰

- âœ… `swift test` èƒ½åœ¨æœ¬åœ°å’Œ CI è·‘å®Œå…¨éƒ¨æµ‹è¯•ï¼ˆä¸å†ä¾èµ– sh ä½œä¸ºæµ‹è¯•å®ç°ï¼‰
- âœ… GameCore çš„æ ¸å¿ƒè§„åˆ™æœ‰å¼ºæ–­è¨€å•å…ƒæµ‹è¯•è¦†ç›–ï¼ˆå†…éƒ¨é€»è¾‘ä¸å¯â€œç©ºå®ç°â€ï¼‰
- âœ… GameCLI çš„å…³é”®ç”¨æˆ·è·¯å¾„æœ‰ Swift UI tests è¦†ç›–ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶çœŸå®è¿è¡Œï¼‰
- âœ… æ¯ä¸ªæµ‹è¯•éƒ½æœ‰ä¸­æ–‡è¯´æ˜ï¼Œæœªæ¥æ‰©å±•ä¹Ÿæœ‰ç¨³å®šå›å½’ä¿æŠ¤


