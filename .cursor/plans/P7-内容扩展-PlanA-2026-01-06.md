## P7：内容扩展（先 Act1，再 Act2）- Plan A（2026-01-06）

> 目标：在已完成 P6（多敌人 + 目标选择）的基础上，优先扩充 **Act1 的内容量与多样性**（真 Boss / 更多敌人&遭遇 / 更多卡牌 / 更多遗物），并在后续阶段引入 **Act2 骨架**。  
> 约束：遵守现有 PDD 架构（Definition + Registry + 强类型 ID + Effect 管线），保持 RNG 可复现；每个阶段完成后必须验证 **能成功 build**（尽量同时保持 `swift test` 全绿）。  
> 备注：本 Plan 以“先 Act1”的优先级编排（你已确认）。Act2 放在后置阶段。

---

### P1：Act1 真 Boss（替换临时 Boss）

**状态（已执行）**
- ✅ 完成（2026-01-06）：新增 Boss「毒雾巨像」并替换当前临时 Boss
- ✅ 验证：`swift build` / `swift test` 通过

**目标**
- 不再复用 `slime_medium_acid` 作为 Boss；实现至少 1 个拥有**独特行动循环/机制**的 Act1 Boss（仍基于 `EnemyDefinition` + `EnemyRegistry`）。
- Boss 的动作设计必须可复现，并能在 CLI 中明确展示意图与结算。

**涉及代码（优先逐个确认/修改）**
- `Sources/GameCore/Enemies/EnemyRegistry.swift`：注册新 Boss 定义
- `Sources/GameCore/Enemies/Definitions/Act1/*`：新增 Boss 定义文件（建议单独建 `Act1Bosses.swift`，避免 BasicEnemies 过长）
- `Sources/GameCLI/Rooms/Handlers/BossRoomHandler.swift`：替换 Boss 选择逻辑
- （可选，增强可扩展）`Sources/GameCore/Enemies/*`：新增 `Act1BossPool`（基于 seed 可复现地选择 Boss）

**设计要点**
- Boss 行动循环建议以 `snapshot.turn` 驱动（例如 4 回合循环），避免引入“隐式记忆状态”。
- 优先复用现有状态（`weak/vulnerable/frail/poison/strength/dexterity`）做机制，不新增引擎分支。

**验收**
- Boss 战不再是史莱姆；Boss 拥有至少 3 种不同动作，并能形成可理解的循环。

**验证**
- `swift build`
- `swift test`
- `swift build -c release`

---

### P2：Act1 敌人扩充 + 遭遇池扩充（含更多多敌人）

**状态（已执行）**
- ✅ 完成（2026-01-06）：新增普通敌人「孢子兽 / 酸液幼体」，新增精英「岩石守卫」，并扩充弱遭遇池（单体+多敌人组合）
- ✅ 验证：`swift build` / `swift test` 通过

**目标**
- 增加 Act1 普通敌人种类、精英敌人种类，并扩充 `Act1EncounterPool` 的多敌人遭遇组合（不依赖 `SALU_FORCE_MULTI_ENEMY` 也能更常遇到多敌人）。

**涉及代码**
- `Sources/GameCore/Enemies/Definitions/Act1/*`：新增普通/精英敌人定义
- `Sources/GameCore/Enemies/EnemyRegistry.swift`：注册新敌人
- `Sources/GameCore/Enemies/EnemyPool.swift`：扩充 `Act1EnemyPool.weak/medium`
- `Sources/GameCore/Enemies/Act1EncounterPool.swift`：扩充 `weak` 遭遇列表（可加入 2 同类/2 异类组合）
- `Sources/GameCLI/Rooms/Handlers/BattleRoomHandler.swift`：普通战斗继续使用遭遇池（必要时做权重/过滤策略）
- `Sources/GameCLI/Rooms/Handlers/EliteRoomHandler.swift`：精英战斗池扩充后自动生效

**验收**
- 普通战斗可稳定出现多种敌人；多敌人遭遇数量明显增加（至少 3 种不同组合）。
- 精英战斗不再只有一种敌人。

**验证**
- `swift build`
- `swift test`

---

### P3：Act1 卡牌扩充（与多敌人协同）

**状态（已执行）**
- ✅ 完成（2026-01-06）：新增 4 张卡牌（横扫/威吓/敏捷姿态/淬毒打击），其中横扫/威吓为 AoE，和多敌人战斗协同
- ✅ 验证：`swift build` / `swift test` 通过

**目标**
- 增加卡牌数量与类型覆盖：至少补 1 张 AoE（可通过 `snapshot.enemies` 生成多段 `.dealDamage` 实现，无需新增引擎效果枚举），并补充若干单体攻击/防御/能力牌。

**涉及代码**
- `Sources/GameCore/Cards/Definitions/Ironclad/*`：新增卡牌定义文件（建议按稀有度或主题拆分文件，避免单文件膨胀）
- `Sources/GameCore/Cards/CardRegistry.swift`：注册新卡牌
- `Sources/GameCore/Rewards/CardPool.swift` / `Shop/*`：会自动纳入奖励/商店（如需特殊池，另开策略）
- `Sources/GameCLI/Screens/BattleScreen.swift`：规则文本展示应来自 `CardDefinition.rulesText`（新增卡牌必须补齐文案）

**验收**
- 战斗奖励/商店能出现新卡；至少 1 张 AoE 可在双敌人战斗中正确结算并记录事件。

**验证**
- `swift build`
- `swift test`

---

### P4：Act1 遗物扩充（含 Boss 稀有度遗物）

**状态（已执行）**
- ✅ 完成（2026-01-06）：新增 4 件遗物（普通/罕见/稀有/Boss 各 1）；并修正 `RelicDropStrategy` 按稀有度优先选择
- ✅ 验证：`swift build` / `swift test` / `swift build -c release` 通过

**目标**
- 增加遗物数量，并利用现有触发点（`battleStart/turnStart/turnEnd/cardPlayed/battleEnd`）做出可感知差异。
- 至少增加 1 个 `boss` 稀有度遗物，验证 `RelicDropStrategy` 的稀有度优先级逻辑可用。

**涉及代码**
- `Sources/GameCore/Relics/Definitions/*`：新增遗物定义
- `Sources/GameCore/Relics/RelicRegistry.swift`：注册新遗物
- `Sources/GameCore/Relics/RelicPool.swift` / `RelicDropStrategy.swift`：自动纳入掉落池（注意排除 starter/重复）
- `Sources/GameCLI/Screens/RelicRewardScreen.swift`：展示与选择流程应保持中文与一致布局

**验收**
- 精英/Boss 掉落遗物池明显扩充；Boss 稀有度遗物可被正确掉落与持久化。

**验证**
- `swift build`
- `swift test`
- `swift build -c release`

---

### P5：内容资源管理页面 + 内容代码组织（开发者工具）

**状态（已执行）**
- ✅ 完成（2026-01-06）：新增 `ResourceScreen` 并接入设置菜单；卡牌/敌人/遗物定义按分类重组
- ✅ 验证：`swift build` / `swift test` 通过

**目标**
- 在 CLI 增加一个「资源管理」页面：可查看当前已注册的卡牌/敌人/遗物，以及 Act1 的敌人池/遭遇池等关键“池子”内容。
- 提供基础数据洞察：按类型/稀有度统计数量、遭遇池双敌人占比等。
- 同步整理内容代码文件结构（不改行为）：  
  - 卡牌按 **攻击/技能/能力** 拆文件  
  - 敌人按 **普通/精英/Boss** 拆文件  
  - 遗物按 **稀有度** 拆文件

**涉及代码**
- `Sources/GameCLI/Screens/*`：新增 `ResourceScreen.swift`（或同等命名），并在设置/主菜单中增加入口
- `Sources/GameCore/*Registry.swift`：如有需要，补充 `all*Ids` 以便资源页面列举（保持无 Foundation）
- `Sources/GameCore/Cards/Definitions/*`：按类型整理文件（迁移定义）
- `Sources/GameCore/Enemies/Definitions/*`：按普通/精英/Boss 整理文件（迁移定义）
- `Sources/GameCore/Relics/Definitions/*`：按稀有度整理文件（迁移定义）
- `Tests/GameCLITests/*`：新增覆盖测试（至少确保资源页面能渲染并包含关键条目）

**验收**
- CLI 中可打开「资源管理」页面，且能看到：
  - 卡牌按类型分组的列表与数量
  - 遗物按稀有度分组的列表与数量
  - Act1 敌人池/遭遇池列表（含双敌人占比）
- 代码结构按约定分类后仍能正常编译与运行（无行为回归）

**验证**
- `swift build`
- `swift test`

---

### P6：Act2 骨架（后置，但在 P7 内收敛）

**状态（已执行）**
- ✅ 完成（2026-01-06）：实现 Act1→Act2 推进（`RunState.maxFloor`），新增 Act2 敌人池/遭遇池/Boss，并升级存档版本（RunSaveVersion=2）
- ✅ 验证：`swift test` / `swift build -c release` 通过

**目标**
- 引入 Act2 的最小“可玩骨架”：新的地图生成策略、新的敌人池/遭遇池、新的 Boss 入口，并支持 Act1→Act2 的切换。
- 不做向后兼容（按仓库策略）：RunSnapshot/版本号需要同步升级。

**涉及代码（预评估）**
- `Sources/GameCore/Map/*`：新增 Act2 MapGenerator（或 `BranchingMapGenerator` 的 Act 参数化）
- `Sources/GameCore/Run/*`：RunState 需要能表达“当前 Act/楼层/进度”，Boss 击败后推进到下个 Act
- `Sources/GameCLI/*`：地图标题/流程提示需能体现 Act2
- `Tests/*`：新增 Act2 的确定性与流程测试

**验收**
- 一次完整流程可从 Act1 通关推进到 Act2，并能进入至少 1 场 Act2 战斗（内容可先少，但链路必须全）。

**验证**
- `swift build`
- `swift test`
- `swift build -c release`

---

### 全程统一验证要求（每个 Px 完成后）

- `swift build`
- （推荐）`swift test`
- 重要阶段额外：`swift build -c release`


