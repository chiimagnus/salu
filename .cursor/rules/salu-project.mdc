---
description: Salu 项目开发规范 - 架构、代码风格、命名规范
globs: Sources/**/*.swift,Package.swift
alwaysApply: true
---

# Salu 项目开发规范

## 架构原则

### 模块分离

```
GameCore/  ← 纯逻辑层（禁止 print、禁止 UI）
GameCLI/   ← 表现层（CLI 交互）
```

**重要**：单向依赖 `CLI → GameCore`，GameCore 绝不能 import CLI。

### GameCore 模块规范

- **禁止** `print()` 或任何输出
- **禁止** 读取 stdin
- **禁止** 导入 UI 框架
- **必须** 所有类型标记为 `public`
- **必须** 遵循 `Sendable` 协议（支持并发）

### 文件职责

| 文件 | 职责 |
|------|------|
| [Models.swift](mdc:Sources/GameCore/Models.swift) | 数据模型：Card, Entity, BattleState |
| [RNG.swift](mdc:Sources/GameCore/RNG.swift) | 可复现随机数生成器 |
| [Events.swift](mdc:Sources/GameCore/Events.swift) | 战斗事件枚举 |
| [Actions.swift](mdc:Sources/GameCore/Actions.swift) | 玩家动作枚举 |
| [BattleEngine.swift](mdc:Sources/GameCore/BattleEngine.swift) | 战斗逻辑引擎 |

---

## 代码风格

### Swift 6 并发安全

```swift
// ✅ 正确：标记 Sendable
public struct Card: Identifiable, Sendable { ... }

// ✅ 正确：使用 @unchecked Sendable 处理可变状态
public final class BattleEngine: @unchecked Sendable { ... }
```

### 事件驱动设计

```swift
// ✅ 正确：通过事件记录状态变化
emit(.damageDealt(source: "玩家", target: "敌人", amount: 6, blocked: 0))

// ❌ 错误：在 GameCore 中直接 print
print("造成 6 点伤害")  // 禁止！
```

### 可复现性要求

```swift
// ✅ 正确：使用注入的 RNG
let shuffled = rng.shuffled(deck)

// ❌ 错误：使用系统随机数
let shuffled = deck.shuffled()  // 不可复现！
```

---

## 扩展指南

### 添加新卡牌

1. 在 `CardKind` 添加新枚举值
2. 在 `Card` 中添加对应的 cost/damage/block
3. 在 `BattleEngine.executeCardEffect()` 添加效果实现
4. 在 `createStarterDeck()` 中按需添加

### 添加 Buff/Debuff

1. 在 `Entity` 中添加状态字段
2. 创建 `StatusEffect` 枚举
3. 在伤害计算中应用修正
4. 在回合结束时递减持续时间

---

## 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 类型名 | `PascalCase` | `BattleEngine` |
| 变量名 | `camelCase` | `currentHP` |
| 事件名 | `camelCase` | `damageDealt` |
| 文件名 | 与主类型同名 | `BattleEngine.swift` |

---

## 测试要求

### 运行测试

```bash
# 运行完整测试
./Scripts/test_game.sh

# 仅编译测试
./Scripts/test_game.sh build

# 可复现性测试
./Scripts/test_game.sh reproduce
```

### 验收标准

- [ ] `swift build` 编译成功
- [ ] `swift build -c release` 编译成功
- [ ] `swift run GameCLI --seed 1` 能跑完一局
- [ ] 同一 seed + 同样输入 → 结果一致
- [ ] 抽牌堆耗尽时正确洗回弃牌堆
- [ ] 伤害与格挡结算正确

---

## 提交检查清单

- [ ] `swift build` 无错误
- [ ] `swift build` 无警告（尽量）
- [ ] GameCore 无 print 语句
- [ ] 所有 public 类型标记 Sendable
- [ ] 新功能有对应事件
- [ ] 业务变更同步更新 [CLAUDE.mdc](mdc:.cursor/rules/CLAUDE.mdc)
