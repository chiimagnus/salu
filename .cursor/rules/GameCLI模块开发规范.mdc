---
description: GameCLI 模块开发规范 - 表现层
globs: Sources/GameCLI/**/*.swift
alwaysApply: true
---

# GameCLI 模块开发规范

> **设定与剧情**请参阅：`.cursor/rules/Salu游戏设定与剧情（v0.1）.mdc`
> **卡牌/敌人/遗物命名映射**见业务说明文档的"克苏鲁风格重命名"章节。

## 模块定位

GameCLI 是**表现层**，负责终端界面渲染、用户输入处理。

```
Sources/GameCLI/  ← 本规范适用范围
│
├── Screens/                    # ✅ 界面系统（主菜单/地图/战斗/历史/统计/资源管理等）
├── Components/                 # ✅ UI 组件（事件格式化、导航栏等）
├── Flow/                       # ✅ RoomHandling 协议与注册表
├── Rooms/Handlers/             # ✅ 房间行为（Start/Battle/Elite/Rest/Boss）
├── Persistence/                # ✅ 存储实现与服务（历史/存档/设置/日志）
├── GameCLI.swift               # ✅ 主入口、游戏循环
├── Terminal.swift              # ✅ ANSI 控制码、终端工具
└── Screens.swift               # ✅ 界面统一入口
```

> 说明：✅ 已实现（后续 Reward/Shop/AI 将按计划在新增目录中扩展）

---

## 设计原则

### 单一职责原则（SRP）

每个文件只负责一个明确的功能领域：

| 文件 | 单一职责 | 禁止混入 |
|------|----------|----------|
| `Terminal.swift` | 终端底层控制 | UI 逻辑、业务逻辑 |
| `EventFormatter.swift` | 事件 → 文本 | 屏幕布局、输入处理 |
| `Screens/BattleScreen.swift` | 战斗界面构建 | 菜单逻辑、事件格式化 |
| `Screens.swift` | 屏幕统一入口（聚合调用） | 游戏循环、状态管理 |
| `Persistence/HistoryService.swift` | 战绩读写协调（依赖注入） | UI 渲染、文件路径策略 |
| `Persistence/SaveService.swift` | Run 存档业务（快照/恢复） | UI 渲染、文件 I/O 细节 |
| `Persistence/SettingsStore.swift` | 用户设置持久化（日志显示等） | UI 渲染、业务逻辑 |
| `Persistence/RunLogService.swift` | 冒险日志落盘（调试用） | UI 渲染 |
| `GameCLI.swift` | 流程控制 | 具体渲染实现 |

### 组件化原则

1. **新增 UI 组件时**：考虑是否需要独立文件
2. **文件超过 300 行**：考虑拆分
3. **功能可复用时**：抽取为独立组件

```swift
// ✅ 正确：按职责拆分
// Terminal.swift - 底层工具
// Components/EventFormatter.swift - 事件格式化
// Screens/*.swift - 各界面渲染
// Flow + Rooms/Handlers - 房间流程

// ❌ 错误：一个文件包含所有 UI 代码
```

### 依赖方向

```
GameCLI.swift
    ↓ 调用
┌──────────────────────────┬──────────────────────────┐
│ Screens.swift (+ Screens/)| Flow/RoomHandlerRegistry │
└──────────────────────────┴──────────────────────────┘
    ↓ 调用
┌────────────────────────────────────────────────────┐
│ Terminal.swift                                     │
│ Components/* (EventFormatter/NavigationBar)        │
│ Persistence/* (History/Save/Settings/RunLog)       │
└────────────────────────────────────────────────────┘
    ↓ 导入
┌──────────────────────────────────────────┐
│               GameCore                    │
└──────────────────────────────────────────┘
```

---

## 协议驱动开发（PDD）在 GameCLI 的落地点

- **UI 渲染不写 switch**：卡牌/状态/敌人展示从 `CardRegistry/StatusRegistry/EnemyRegistry` 取 `name/rulesText/icon/intent` 渲染
- **房间流程可插拔**：通过 `RoomHandling` + `RoomHandlerRegistry` 扩展房间行为，`GameCLI.runLoop` 不写 roomType 分支
- **依赖注入优先**：History/Save 等 I/O 能力通过 Service 注入到 Screens/Handlers，避免在 Screen 内部创建文件存储

---

## 核心约束

### 必须遵守

- ✅ 颜色输出使用 `Terminal` 常量
- ✅ 屏幕刷新使用清屏+重绘模式
- ✅ 所有用户可见文本使用中文
- ✅ 每个文件职责单一明确

### 依赖关系

```
GameCLI → GameCore  ✅ 允许
GameCore → GameCLI  ❌ 禁止
```

---

## 文件职责详解

| 文件/目录 | 职责 | 典型内容 |
|------|------|----------|
| `GameCLI.swift` | 入口、菜单、游戏循环、依赖注入 | main(), runLoop() |
| `Terminal.swift` | ANSI 颜色码、光标控制 | clear(), flush(), 颜色常量 |
| `Components/EventFormatter.swift` | BattleEvent → 彩色字符串 | format() |
| `Screens/*.swift` | 单个界面渲染与输入处理 | showMainMenu(), renderBattleScreen(), renderMap(), PrologueScreen, ChapterEndScreen |
| `Screens.swift` | 全屏界面统一入口 | showMainMenu(), showHelp() |
| `Flow/RoomHandling.swift` | 房间处理协议/上下文 | RoomHandling, RoomContext, RoomRunResult |
| `Flow/RoomHandlerRegistry.swift` | RoomType → handler 注册表 | register()/resolve() |
| `Rooms/Handlers/*.swift` | 房间行为实现 | StartRoomHandler, BattleRoomHandler 等 |
| `Persistence/HistoryService.swift` | 战绩读写协调 | getAllRecords(), addRecord(), clearHistory() |
| `Persistence/FileBattleHistoryStore.swift` | 战绩文件实现 | append(), clear() |
| `Persistence/SaveService.swift` | Run 存档业务（快照/恢复） | createSnapshot(), restoreRunState() |
| `Persistence/FileRunSaveStore.swift` | Run 存档文件实现 | load(), save(), hasSave() |
| `Persistence/SettingsStore.swift` | 用户设置存储 | load(), save(), Settings |
| `Persistence/RunLogService.swift` | 冒险日志服务 | append(), clear() |
| `Persistence/FileRunLogStore.swift` | 冒险日志文件实现 | append(), clear() |
| `Components/NavigationBar.swift` | 导航栏与返回提示 | render(), waitForBack() |

---

## 导航栏组件（NavigationBar）

统一的底部导航栏，用于在界面底部显示操作提示：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⌨️ [q] 返回
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
请选择 > 
```

### 使用方式

```swift
// 渲染导航栏
NavigationBar.render(items: [.back])

// 等待用户输入 q 返回
NavigationBar.waitForBack()
```

### 可用导航项

| Item | 显示 |
|------|------|
| `.back` | `[q] 返回` |
| `.continueNext` | `[q] 继续` |
| `.backToMenu` | `[q] 返回主菜单` |
| `.backToGame` | `[q] 返回游戏` |
| `.custom(key:label:)` | 自定义 |

---

## 扩展指南

### 添加新界面

1. 如果是全屏/独立界面 → 在 `Screens/` 目录新增文件，并在 `Screens.swift` 入口调用。
2. 战斗/地图等局部更新 → 修改对应的 `Screens/*.swift`。
3. 房间流程逻辑 → 新增 `Rooms/Handlers/*.swift` 并在 `RoomHandlerRegistry` 注册。

### 添加新菜单项

1. 在 `Screens.swift` 更新菜单显示
2. 在 `GameCLI.swift` 添加输入处理

### 添加新命令行参数

1. 在 `GameCLI.main()` 添加参数检查
2. 更新 CLAUDE.mdc 文档

### 存档/继续冒险

- 冒险模式会在**节点完成后自动保存**（`GameCLI.runLoop` 调用 `SaveService.saveRun`）。
- 主菜单会根据 `SaveService.hasSave()` 决定是否显示“继续上次冒险”入口。
- `FileRunSaveStore` 支持通过环境变量 `SALU_DATA_DIR` 覆盖存档目录（用于测试/调试；默认仍写入系统 Application Support/LOCALAPPDATA/~/.salu）。
- `FileRunSaveStore` / `FileBattleHistoryStore` / `SettingsStore` / `FileRunLogStore` 支持通过环境变量 `SALU_DATA_DIR` 覆盖数据目录（用于测试/调试；默认仍写入系统 Application Support/LOCALAPPDATA/~/.salu）。
- CLI 测试模式支持 `SALU_TEST_MAP` 使用极小地图以加速 UI 测试流程：
  - `SALU_TEST_MAP=1` 或 `mini`：起点 → 精英 → Boss
  - `SALU_TEST_MAP=battle`：起点 → 普通战斗 → Boss（用于多敌人/目标选择 UI 测试）
  - `SALU_TEST_MAP=shop/rest/event`：起点 → 对应房间 → Boss
- CLI 测试模式支持 `SALU_TEST_MAX_FLOOR` 覆盖最大楼层（Act 数），默认 `1`：
  - `SALU_TEST_MAX_FLOOR=2`：用于验证“击败 Act1 Boss → 进入 Act2”链路与存档持久化
- （调试/验收）`SALU_FORCE_MULTI_ENEMY=1`：强制普通战斗进入双敌人遭遇（便于验证目标选择）

### 用户设置持久化

- 用户设置（如日志显示开关）通过 `SettingsStore` 持久化到 `settings.json`。
- 游戏启动时自动加载设置，设置菜单中修改后立即保存。
- 设置文件位于游戏数据目录（与存档/战绩同目录）。

---

## 终端控制

### 颜色使用

```swift
// 使用 Terminal 常量
print("\(Terminal.red)错误文本\(Terminal.reset)")
print("\(Terminal.bold)\(Terminal.green)成功\(Terminal.reset)")

// 可用颜色
Terminal.red      // 红色（敌人、伤害、错误）
Terminal.green    // 绿色（玩家、成功、可用）
Terminal.yellow   // 黄色（能量、警告、意图）
Terminal.blue     // 蓝色（玩家名称）
Terminal.cyan     // 青色（格挡、回合信息）
Terminal.magenta  // 洋红（特殊效果）
Terminal.bold     // 加粗
Terminal.dim      // 暗淡
Terminal.reset    // 重置
```

### 屏幕刷新

```swift
// 清屏并刷新整个界面
Terminal.clear()  // 清屏 + 光标归位
// ... 打印所有内容 ...
Terminal.flush()  // 刷新缓冲区
```

---

## 界面布局

战斗主界面固定布局：

```
┌─────────────────────────────────────────────┐
│ 标题栏（回合数、种子）                         │
├─────────────────────────────────────────────┤
│ 敌人区域（敌人列表：序号、名称、HP条、格挡、意图）│
├ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┤
│ 玩家区域（名称、HP条、格挡、能量）              │
├─────────────────────────────────────────────┤
│ 手牌区域（卡牌列表）                          │
├─────────────────────────────────────────────┤
│ 牌堆信息（抽牌堆/弃牌堆）                      │
├─────────────────────────────────────────────┤
│ 事件日志（最近6条）                           │
├─────────────────────────────────────────────┤
│ 消息区域（错误提示等）                        │
├━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┤
│ 操作提示栏                                   │
└─────────────────────────────────────────────┘
```

---

## 检查清单

- [ ] 颜色使用 Terminal 常量
- [ ] 屏幕刷新使用清屏模式
- [ ] 界面布局保持一致
- [ ] 文件职责单一明确
- [ ] 新组件考虑复用性
