---
description: GameCore æ¨¡å—å¼€å‘è§„èŒƒ - çº¯é€»è¾‘å±‚
globs: Sources/GameCore/**/*.swift
alwaysApply: true
---

# GameCore æ¨¡å—å¼€å‘è§„èŒƒ

## æ¨¡å—å®šä½

GameCore æ˜¯**çº¯é€»è¾‘å±‚**ï¼Œè´Ÿè´£æ¸¸æˆè§„åˆ™ã€çŠ¶æ€ç®¡ç†ã€è®¡ç®—ã€‚

```
Sources/GameCore/  â† æœ¬è§„èŒƒé€‚ç”¨èŒƒå›´
â”‚
â”œâ”€â”€ Battle/                 # âœ… æˆ˜æ–—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ BattleEngine.swift  # æˆ˜æ–—å¼•æ“ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ BattleState.swift   # æˆ˜æ–—çŠ¶æ€
â”‚   â””â”€â”€ BattleStats.swift   # æˆ˜æ–—ç»Ÿè®¡
â”‚
â”œâ”€â”€ Cards/                  # âœ… å¡ç‰Œç³»ç»Ÿ
â”‚   â”œâ”€â”€ CardKind.swift      # å¡ç‰Œç§ç±»æšä¸¾
â”‚   â”œâ”€â”€ Card.swift          # å¡ç‰Œæ¨¡å‹
â”‚   â””â”€â”€ StarterDeck.swift   # åˆå§‹ç‰Œç»„é…ç½®
â”‚
â”œâ”€â”€ Entity/                 # âœ… å®ä½“ç³»ç»Ÿ
â”‚   â””â”€â”€ Entity.swift        # å®ä½“æ¨¡å‹ï¼ˆç©å®¶/æ•Œäººï¼‰
â”‚
â”œâ”€â”€ Run/                    # ğŸ”œ æ¸¸æˆä¼šè¯ç³»ç»Ÿï¼ˆè®¡åˆ’ä¸­ï¼‰
â”‚   â”œâ”€â”€ RunState.swift      # å½“å‰å†’é™©çŠ¶æ€
â”‚   â”œâ”€â”€ RunProgress.swift   # ç©å®¶è¿›åº¦
â”‚   â””â”€â”€ RunManager.swift    # å†’é™©ç®¡ç†å™¨
â”‚
â”œâ”€â”€ Map/                    # ğŸ”œ åœ°å›¾ç³»ç»Ÿï¼ˆè®¡åˆ’ä¸­ï¼‰
â”‚   â”œâ”€â”€ MapNode.swift       # åœ°å›¾èŠ‚ç‚¹
â”‚   â”œâ”€â”€ MapPath.swift       # è·¯å¾„å®šä¹‰
â”‚   â”œâ”€â”€ MapGenerator.swift  # åœ°å›¾ç”Ÿæˆ
â”‚   â””â”€â”€ RoomType.swift      # æˆ¿é—´ç±»å‹
â”‚
â”œâ”€â”€ Enemies/                # ğŸ”œ æ•Œäººç³»ç»Ÿï¼ˆè®¡åˆ’ä¸­ï¼‰
â”‚   â”œâ”€â”€ EnemyKind.swift     # æ•Œäººç§ç±»æšä¸¾
â”‚   â”œâ”€â”€ EnemyAI.swift       # æ•Œäºº AI è¡Œä¸º
â”‚   â”œâ”€â”€ EnemyIntent.swift   # æ•Œäººæ„å›¾
â”‚   â””â”€â”€ EnemyPool.swift     # æ•Œäººæ± /é­é‡è¡¨
â”‚
â”œâ”€â”€ Relics/                 # ğŸ”œ é—ç‰©ç³»ç»Ÿï¼ˆè®¡åˆ’ä¸­ï¼‰
â”‚   â”œâ”€â”€ RelicKind.swift     # é—ç‰©ç§ç±»
â”‚   â”œâ”€â”€ RelicEffect.swift   # é—ç‰©æ•ˆæœ
â”‚   â””â”€â”€ RelicTrigger.swift  # è§¦å‘æ—¶æœº
â”‚
â”œâ”€â”€ Rewards/                # ğŸ”œ å¥–åŠ±ç³»ç»Ÿï¼ˆè®¡åˆ’ä¸­ï¼‰
â”‚   â”œâ”€â”€ RewardType.swift    # å¥–åŠ±ç±»å‹
â”‚   â””â”€â”€ RewardGenerator.swift # å¥–åŠ±ç”Ÿæˆ
â”‚
â”œâ”€â”€ AI/                     # ğŸ”œ AI å­ç³»ç»Ÿï¼ˆè®¡åˆ’ä¸­ï¼‰
â”‚   â”œâ”€â”€ AIProvider.swift    # AI æœåŠ¡åè®®
â”‚   â”œâ”€â”€ AIPromptBuilder.swift # æ„å»º AI æç¤ºè¯
â”‚   â”œâ”€â”€ AIDecision.swift    # AI å†³ç­–æ¨¡å‹
â”‚   â””â”€â”€ GameStateEncoder.swift # æ¸¸æˆçŠ¶æ€åºåˆ—åŒ–
â”‚
â”œâ”€â”€ Actions.swift           # âœ… ç©å®¶åŠ¨ä½œå®šä¹‰
â”œâ”€â”€ Events.swift            # âœ… æˆ˜æ–—äº‹ä»¶å®šä¹‰
â”œâ”€â”€ History.swift           # âœ… æˆ˜ç»©æ•°æ®æ¨¡å‹
â””â”€â”€ RNG.swift               # âœ… éšæœºæ•°ç”Ÿæˆå™¨
```

> è¯´æ˜ï¼šâœ… å·²å®ç° | ğŸ”œ è®¡åˆ’ä¸­ï¼ˆè¯¦è§ `.cursor/plans/architecture-design.md`ï¼‰

---

## è®¾è®¡åŸåˆ™

### å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰

æ¯ä¸ªæ–‡ä»¶åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„é¢†åŸŸï¼š

| æ–‡ä»¶ | å•ä¸€èŒè´£ | ç¦æ­¢æ··å…¥ |
|------|----------|----------|
| `Models.swift` | æ•°æ®ç»“æ„å®šä¹‰ | ä¸šåŠ¡é€»è¾‘ã€è®¡ç®— |
| `Events.swift` | äº‹ä»¶ç±»å‹å®šä¹‰ | äº‹ä»¶å¤„ç†é€»è¾‘ |
| `Actions.swift` | åŠ¨ä½œç±»å‹å®šä¹‰ | åŠ¨ä½œæ‰§è¡Œé€»è¾‘ |
| `RNG.swift` | éšæœºæ•°ç”Ÿæˆ | æ¸¸æˆè§„åˆ™ |
| `BattleEngine.swift` | æˆ˜æ–—é€»è¾‘ | æ•°æ®æ¨¡å‹å®šä¹‰ |
| `History.swift` | æˆ˜ç»©æ•°æ®ç»“æ„ | æŒä¹…åŒ–é€»è¾‘ |

### ç»„ä»¶åŒ–åŸåˆ™

1. **æ–°å¢åŠŸèƒ½æ¨¡å—æ—¶**ï¼šè€ƒè™‘æ˜¯å¦éœ€è¦ç‹¬ç«‹æ–‡ä»¶
2. **æ–‡ä»¶è¶…è¿‡ 200 è¡Œ**ï¼šè€ƒè™‘æ‹†åˆ†
3. **ç±»å‹å¯ç‹¬ç«‹ä½¿ç”¨æ—¶**ï¼šæŠ½å–ä¸ºç‹¬ç«‹æ–‡ä»¶

```swift
// âœ… æ­£ç¡®ï¼šæŒ‰é¢†åŸŸæ‹†åˆ†
// Models.swift - æ•°æ®æ¨¡å‹
// Events.swift - äº‹ä»¶å®šä¹‰
// BattleEngine.swift - æˆ˜æ–—é€»è¾‘

// âŒ é”™è¯¯ï¼šæ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶
```

### ä¾èµ–æ–¹å‘

```
BattleEngine.swift
    â†“ ä½¿ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Models.swift â”‚ Events.swift â”‚ Actions.swift â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ä½¿ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RNG.swift                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒçº¦æŸ

### ä¸¥æ ¼ç¦æ­¢

- âŒ `print()` æˆ–ä»»ä½•æ§åˆ¶å°è¾“å‡º
- âŒ è¯»å– `stdin` æˆ–ä»»ä½•ç”¨æˆ·è¾“å…¥
- âŒ å¯¼å…¥ `Foundation`ï¼ˆHistory.swift é™¤å¤–ï¼‰
- âŒ å¯¼å…¥ä»»ä½• UI æ¡†æ¶
- âŒ å¯¼å…¥ GameCLI æ¨¡å—

### å¿…é¡»éµå®ˆ

- âœ… æ‰€æœ‰ç±»å‹æ ‡è®°ä¸º `public`
- âœ… éµå¾ª `Sendable` åè®®ï¼ˆæ”¯æŒå¹¶å‘ï¼‰
- âœ… é€šè¿‡äº‹ä»¶ç³»ç»Ÿè®°å½•çŠ¶æ€å˜åŒ–
- âœ… ä½¿ç”¨æ³¨å…¥çš„ RNG ä¿è¯å¯å¤ç°æ€§
- âœ… æ¯ä¸ªæ–‡ä»¶èŒè´£å•ä¸€æ˜ç¡®

---

## ä»£ç é£æ ¼

### Swift 6 å¹¶å‘å®‰å…¨

```swift
// âœ… æ­£ç¡®ï¼šç»“æ„ä½“æ ‡è®° Sendable
public struct Card: Identifiable, Sendable { ... }

// âœ… æ­£ç¡®ï¼šç±»ä½¿ç”¨ @unchecked Sendable
public final class BattleEngine: @unchecked Sendable { ... }
```

### äº‹ä»¶é©±åŠ¨è®¾è®¡

```swift
// âœ… æ­£ç¡®ï¼šé€šè¿‡äº‹ä»¶è®°å½•çŠ¶æ€å˜åŒ–
private func emit(_ event: BattleEvent) {
    events.append(event)
}

emit(.damageDealt(source: "ç©å®¶", target: "æ•Œäºº", amount: 6, blocked: 0))

// âŒ é”™è¯¯ï¼šç›´æ¥ print
print("é€ æˆ 6 ç‚¹ä¼¤å®³")  // ç¦æ­¢ï¼
```

### å¯å¤ç°æ€§

```swift
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ³¨å…¥çš„ RNG
let shuffled = rng.shuffled(deck)

// âŒ é”™è¯¯ï¼šä½¿ç”¨ç³»ç»Ÿéšæœºæ•°
let shuffled = deck.shuffled()  // ä¸å¯å¤ç°ï¼
```

---

## æ–‡ä»¶èŒè´£è¯¦è§£

| æ–‡ä»¶ | èŒè´£ | å…³é”®ç±»å‹ |
|------|------|----------|
| `Models.swift` | æ•°æ®æ¨¡å‹ | Card, Entity, BattleState |
| `RNG.swift` | éšæœºæ•° | SeededRNG |
| `Events.swift` | äº‹ä»¶å®šä¹‰ | BattleEvent |
| `Actions.swift` | åŠ¨ä½œå®šä¹‰ | PlayerAction |
| `BattleEngine.swift` | æˆ˜æ–—å¼•æ“ | BattleEngine |
| `History.swift` | æˆ˜ç»©æ¨¡å‹ | BattleRecord, BattleStatistics |

---

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°å¡ç‰Œ

1. åœ¨ `CardKind` æšä¸¾æ·»åŠ æ–°å€¼
2. åœ¨ `Card` ä¸­æ·»åŠ å¯¹åº”çš„ cost/damage/block
3. åœ¨ `BattleEngine.executeCardEffect()` å®ç°æ•ˆæœ
4. å¦‚éœ€æ·»åŠ åˆ°åˆå§‹ç‰Œç»„ï¼Œæ›´æ–° `createStarterDeck()`

### æ·»åŠ çŠ¶æ€æ•ˆæœ (Buff/Debuff)

1. åœ¨ `Entity` ä¸­æ·»åŠ çŠ¶æ€å­—æ®µï¼ˆå¦‚ `vulnerable: Int`ï¼‰
2. åˆ›å»º `StatusEffect` æšä¸¾ï¼ˆå¯åœ¨ Models.swift æˆ–æ–°æ–‡ä»¶ï¼‰
3. åœ¨ `BattleEngine` ä¼¤å®³è®¡ç®—ä¸­åº”ç”¨ä¿®æ­£
4. åœ¨å›åˆç»“æŸæ—¶é€’å‡æŒç»­æ—¶é—´
5. æ·»åŠ å¯¹åº”çš„ `BattleEvent` äº‹ä»¶

### æ·»åŠ æ–°åŠŸèƒ½æ¨¡å—

1. **è¯„ä¼°æ˜¯å¦ç‹¬ç«‹**ï¼šæ–°åŠŸèƒ½æ˜¯å¦ä¸ç°æœ‰æ–‡ä»¶èŒè´£ç›¸å…³ï¼Ÿ
2. **åˆ›å»ºæ–°æ–‡ä»¶**ï¼šå¦‚æœæ˜¯å…¨æ–°é¢†åŸŸï¼Œåˆ›å»ºç‹¬ç«‹æ–‡ä»¶
3. **ä¿æŒçº¯é€»è¾‘**ï¼šä¸å¼•å…¥ UI æˆ– I/O ä¾èµ–

---

## å‘½åè§„èŒƒ

| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| ç±»å‹å | `PascalCase` | `BattleEngine` |
| å˜é‡å | `camelCase` | `currentHP` |
| äº‹ä»¶å | `camelCase` | `damageDealt` |
| æ–‡ä»¶å | ä¸ä¸»ç±»å‹åŒå | `BattleEngine.swift` |

---

## æ£€æŸ¥æ¸…å•

- [ ] æ—  `print()` è¯­å¥
- [ ] æ— å¤–éƒ¨ UI æ¡†æ¶å¯¼å…¥
- [ ] æ‰€æœ‰ public ç±»å‹æ ‡è®° Sendable
- [ ] ä½¿ç”¨ RNG è€Œéç³»ç»Ÿéšæœºæ•°
- [ ] çŠ¶æ€å˜åŒ–é€šè¿‡äº‹ä»¶è®°å½•
- [ ] æ–‡ä»¶èŒè´£å•ä¸€æ˜ç¡®
- [ ] ä¸šåŠ¡å˜æ›´åŒæ­¥æ›´æ–° CLAUDE.mdc
