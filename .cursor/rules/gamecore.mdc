---
description: GameCore 模块开发规范 - 纯逻辑层
globs: Sources/GameCore/**/*.swift
alwaysApply: true
---

# GameCore 模块开发规范

## 模块定位

GameCore 是**纯逻辑层**，负责游戏规则、状态管理、计算。

```
Sources/GameCore/  ← 本规范适用范围
├── Models.swift       # 数据模型（Card, Entity, BattleState）
├── RNG.swift          # 随机数生成器
├── Events.swift       # 战斗事件定义
├── Actions.swift      # 玩家动作定义
├── BattleEngine.swift # 战斗引擎（核心逻辑）
└── History.swift      # 战绩数据模型
```

---

## 设计原则

### 单一职责原则（SRP）

每个文件只负责一个明确的领域：

| 文件 | 单一职责 | 禁止混入 |
|------|----------|----------|
| `Models.swift` | 数据结构定义 | 业务逻辑、计算 |
| `Events.swift` | 事件类型定义 | 事件处理逻辑 |
| `Actions.swift` | 动作类型定义 | 动作执行逻辑 |
| `RNG.swift` | 随机数生成 | 游戏规则 |
| `BattleEngine.swift` | 战斗逻辑 | 数据模型定义 |
| `History.swift` | 战绩数据结构 | 持久化逻辑 |

### 组件化原则

1. **新增功能模块时**：考虑是否需要独立文件
2. **文件超过 200 行**：考虑拆分
3. **类型可独立使用时**：抽取为独立文件

```swift
// ✅ 正确：按领域拆分
// Models.swift - 数据模型
// Events.swift - 事件定义
// BattleEngine.swift - 战斗逻辑

// ❌ 错误：所有内容放在一个文件
```

### 依赖方向

```
BattleEngine.swift
    ↓ 使用
┌──────────────────────────────────────────┐
│ Models.swift │ Events.swift │ Actions.swift │
└──────────────────────────────────────────┘
    ↓ 使用
┌──────────────────────────────────────────┐
│              RNG.swift                    │
└──────────────────────────────────────────┘
```

---

## 核心约束

### 严格禁止

- ❌ `print()` 或任何控制台输出
- ❌ 读取 `stdin` 或任何用户输入
- ❌ 导入 `Foundation`（History.swift 除外）
- ❌ 导入任何 UI 框架
- ❌ 导入 GameCLI 模块

### 必须遵守

- ✅ 所有类型标记为 `public`
- ✅ 遵循 `Sendable` 协议（支持并发）
- ✅ 通过事件系统记录状态变化
- ✅ 使用注入的 RNG 保证可复现性
- ✅ 每个文件职责单一明确

---

## 代码风格

### Swift 6 并发安全

```swift
// ✅ 正确：结构体标记 Sendable
public struct Card: Identifiable, Sendable { ... }

// ✅ 正确：类使用 @unchecked Sendable
public final class BattleEngine: @unchecked Sendable { ... }
```

### 事件驱动设计

```swift
// ✅ 正确：通过事件记录状态变化
private func emit(_ event: BattleEvent) {
    events.append(event)
}

emit(.damageDealt(source: "玩家", target: "敌人", amount: 6, blocked: 0))

// ❌ 错误：直接 print
print("造成 6 点伤害")  // 禁止！
```

### 可复现性

```swift
// ✅ 正确：使用注入的 RNG
let shuffled = rng.shuffled(deck)

// ❌ 错误：使用系统随机数
let shuffled = deck.shuffled()  // 不可复现！
```

---

## 文件职责详解

| 文件 | 职责 | 关键类型 |
|------|------|----------|
| `Models.swift` | 数据模型 | Card, Entity, BattleState |
| `RNG.swift` | 随机数 | SeededRNG |
| `Events.swift` | 事件定义 | BattleEvent |
| `Actions.swift` | 动作定义 | PlayerAction |
| `BattleEngine.swift` | 战斗引擎 | BattleEngine |
| `History.swift` | 战绩模型 | BattleRecord, BattleStatistics |

---

## 扩展指南

### 添加新卡牌

1. 在 `CardKind` 枚举添加新值
2. 在 `Card` 中添加对应的 cost/damage/block
3. 在 `BattleEngine.executeCardEffect()` 实现效果
4. 如需添加到初始牌组，更新 `createStarterDeck()`

### 添加状态效果 (Buff/Debuff)

1. 在 `Entity` 中添加状态字段（如 `vulnerable: Int`）
2. 创建 `StatusEffect` 枚举（可在 Models.swift 或新文件）
3. 在 `BattleEngine` 伤害计算中应用修正
4. 在回合结束时递减持续时间
5. 添加对应的 `BattleEvent` 事件

### 添加新功能模块

1. **评估是否独立**：新功能是否与现有文件职责相关？
2. **创建新文件**：如果是全新领域，创建独立文件
3. **保持纯逻辑**：不引入 UI 或 I/O 依赖

---

## 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 类型名 | `PascalCase` | `BattleEngine` |
| 变量名 | `camelCase` | `currentHP` |
| 事件名 | `camelCase` | `damageDealt` |
| 文件名 | 与主类型同名 | `BattleEngine.swift` |

---

## 检查清单

- [ ] 无 `print()` 语句
- [ ] 无外部 UI 框架导入
- [ ] 所有 public 类型标记 Sendable
- [ ] 使用 RNG 而非系统随机数
- [ ] 状态变化通过事件记录
- [ ] 文件职责单一明确
- [ ] 业务变更同步更新 CLAUDE.mdc
