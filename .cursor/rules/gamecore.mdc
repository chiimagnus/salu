---
description: GameCore 模块开发规范 - 纯逻辑层
globs: Sources/GameCore/**/*.swift
alwaysApply: true
---

# GameCore 模块开发规范

## 模块定位

GameCore 是**纯逻辑层**，负责游戏规则、状态管理、计算。

```
Sources/GameCore/  ← 本规范适用范围
│
├── Kernel/                 # 强类型 ID / Effect / Trigger 框架
├── Cards/                  # CardDefinition / CardRegistry / StarterDeck
├── Status/                 # StatusDefinition / StatusRegistry / StatusContainer
├── Enemies/                # EnemyDefinition / EnemyRegistry / EnemyPool
├── Relics/                 # 遗物定义与管理器
├── Map/                    # 地图节点与生成策略
├── Run/                    # 冒险状态 / 存档版本 / Snapshot
├── Persistence/            # BattleHistoryStore / RunSaveStore 协议
├── Battle/                 # 战斗引擎与状态
├── Actions.swift           # 玩家动作定义
├── Events.swift            # 战斗事件定义
├── History.swift           # 战绩数据模型
└── RNG.swift               # 随机数生成器
```

> 说明：奖励/AI/多角色仍在规划中，后续规划请参见 `.cursor/plans/backlog-2026-01-04.md`。

---

## 协议驱动开发（PDD）原则

GameCore 的核心目标是把“内容扩展点”从 `enum + switch` 迁移到 **Definition + Registry**：

- **强类型 ID**：`CardID/StatusID/EnemyID/RelicID`（禁止散落字符串）
- **定义协议**：`CardDefinition/StatusDefinition/EnemyDefinition/RelicDefinition`（只做决策/产出效果，不直接 I/O）
- **注册表**：`CardRegistry/StatusRegistry/EnemyRegistry/RelicRegistry`（新增内容的唯一入口）
- **统一效果管线**：`BattleEffect` + `BattleEngine.apply(effect:)`（引擎只负责执行效果并产出事件）

约束：新增卡牌/状态/敌人/遗物应当尽量只做 **新增 Definition + 在 Registry 注册**，避免修改 `BattleEngine` 或引入新的 switch 扩展点。

---

## 设计原则

### 单一职责原则（SRP）

每个文件只负责一个明确的领域：

| 文件/目录 | 单一职责 | 禁止混入 |
|------|----------|----------|
| `Kernel/IDs.swift` | 强类型 ID 定义 | 业务逻辑 |
| `Kernel/BattleEffect.swift` | 效果枚举/目标 | 状态修改 |
| `Cards/*` | 卡牌定义/注册表 | 直接修改 BattleState |
| `Status/*` | 状态定义/注册表/容器 | I/O、事件输出 |
| `Enemies/*` | 敌人定义/注册表/遭遇表 | UI/输入输出 |
| `Battle/BattleEngine.swift` | 战斗流程与效果执行 | UI、持久化 |
| `Run/*` | 冒险状态/存档版本 | CLI 逻辑 |

### 组件化原则

1. **新增功能模块时**：考虑是否需要独立文件
2. **文件超过 200 行**：考虑拆分
3. **类型可独立使用时**：抽取为独立文件

```swift
// ✅ 正确：按领域拆分
// Models.swift - 数据模型
// Events.swift - 事件定义
// BattleEngine.swift - 战斗逻辑

// ❌ 错误：所有内容放在一个文件
```

### 依赖方向

```
Battle/BattleEngine.swift
    ↓ 使用
┌──────────────────────────────────────────┐
│ Kernel/*  Cards/*  Status/*  Enemies/*   │
│ Relics/*  Run/*   Map/*  Actions.swift   │
└──────────────────────────────────────────┘
    ↓ 使用
┌──────────────────────────────────────────┐
│ RNG.swift                                 │
└──────────────────────────────────────────┘
```

---

## 核心约束

### 严格禁止

- ❌ `print()` 或任何控制台输出
- ❌ 读取 `stdin` 或任何用户输入
- ❌ 导入 `Foundation`（`History.swift` 例外；I/O 协议文件也不应依赖 Foundation）
- ❌ 导入任何 UI 框架
- ❌ 导入 GameCLI 模块

### 必须遵守

- ✅ 所有类型标记为 `public`
- ✅ 遵循 `Sendable` 协议（支持并发）
- ✅ 通过事件系统记录状态变化
- ✅ 使用注入的 RNG 保证可复现性
- ✅ 每个文件职责单一明确

---

## 代码风格

### Swift 6 并发安全

```swift
// ✅ 正确：结构体标记 Sendable
public struct Card: Identifiable, Sendable { ... }

// ✅ 正确：类使用 @unchecked Sendable
public final class BattleEngine: @unchecked Sendable { ... }
```

### 事件驱动设计

```swift
// ✅ 正确：通过事件记录状态变化
private func emit(_ event: BattleEvent) {
    events.append(event)
}

emit(.damageDealt(source: "玩家", target: "敌人", amount: 6, blocked: 0))

// ❌ 错误：直接 print
print("造成 6 点伤害")  // 禁止！
```

### 可复现性

```swift
// ✅ 正确：使用注入的 RNG
let shuffled = rng.shuffled(deck)

// ❌ 错误：使用系统随机数
let shuffled = deck.shuffled()  // 不可复现！
```

---

## 文件职责详解

| 文件/目录 | 职责 | 关键类型 |
|------|------|----------|
| `Kernel/IDs.swift` | 强类型 ID | CardID, EnemyID, StatusID, RelicID |
| `Kernel/BattleEffect.swift` | 战斗效果与目标 | BattleEffect, EffectTarget |
| `Kernel/BattleTrigger.swift` | 战斗触发点 | BattleTrigger |
| `Cards/*` | 卡牌定义/注册表/起始牌组 | CardDefinition, CardRegistry, Card |
| `Status/*` | 状态定义/注册表/容器 | StatusDefinition, StatusRegistry, StatusContainer |
| `Enemies/*` | 敌人定义/注册表/遭遇表 | EnemyDefinition, EnemyRegistry, EnemyMove |
| `Relics/*` | 遗物定义/注册表/管理器 | RelicDefinition, RelicRegistry, RelicManager |
| `Map/*` | 地图节点与生成 | MapNode, MapGenerating |
| `Run/*` | 冒险状态/存档数据 | RunState, RunSnapshot |
| `Persistence/*` | 持久化协议 | BattleHistoryStore, RunSaveStore |
| `Battle/BattleEngine.swift` | 战斗引擎 | BattleEngine |
| `Actions.swift` | 动作定义 | PlayerAction |
| `Events.swift` | 事件定义 | BattleEvent |
| `History.swift` | 战绩模型 | BattleRecord, BattleStatistics |

---

## 扩展指南

### 添加新卡牌

1. 创建新的 `CardDefinition` 类型（建议放在 `Cards/Definitions/` 子目录）。
2. 在 `CardRegistry` 中注册 `CardID -> Definition`。
3. 如需加入起始牌组，更新 `createStarterDeck()`；其余场景通过发牌/奖励直接使用 `CardID`。
4. 不要在 `BattleEngine` 添加 switch，效果由 `CardDefinition.play` 返回的 `BattleEffect` 统一执行。

### 添加状态效果 (Buff/Debuff)

1. 创建新的 `StatusDefinition`，定义修正/触发逻辑。
2. 在 `StatusRegistry` 注册 `StatusID -> Definition`。
3. 通过 `StatusContainer.apply` 管理层数，所有修正/触发以 `BattleEffect` 形式返回，由 `BattleEngine` 执行。
3. 在 `BattleEngine` 伤害计算中应用修正
4. 在回合结束时递减持续时间
5. 添加对应的 `BattleEvent` 事件

### 添加新功能模块

1. **评估是否独立**：新功能是否与现有文件职责相关？
2. **创建新文件**：如果是全新领域，创建独立文件
3. **保持纯逻辑**：不引入 UI 或 I/O 依赖

### Run 存档（P7）

- `GameCore` 只提供 **Run 维度**可序列化快照模型（`RunSnapshot`）与版本管理（`RunSaveVersion`）。
- 实际文件读写/JSON 编解码必须在 `GameCLI/Persistence`（`RunSaveStore` 的具体实现）。

---

## 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 类型名 | `PascalCase` | `BattleEngine` |
| 变量名 | `camelCase` | `currentHP` |
| 事件名 | `camelCase` | `damageDealt` |
| 文件名 | 与主类型同名 | `BattleEngine.swift` |

---

## 检查清单

- [ ] 无 `print()` 语句
- [ ] 无外部 UI 框架导入
- [ ] 所有 public 类型标记 Sendable
- [ ] 使用 RNG 而非系统随机数
- [ ] 状态变化通过事件记录
- [ ] 文件职责单一明确
- [ ] 业务变更同步更新 CLAUDE.mdc
