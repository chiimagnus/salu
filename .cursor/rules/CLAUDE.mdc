---
description: Salu 游戏业务说明 - 游戏规则、数值设定、扩展计划
alwaysApply: true
---
# Salu - 杀戮尖塔 CLI 仿制版

## 项目简介

Salu 是一个跨平台（macOS/Windows）的纯 CLI 回合制卡牌战斗游戏，灵感来自《杀戮尖塔》（Slay the Spire）。

## 快速开始

```bash
# 运行游戏（使用固定种子，可复现）
swift run GameCLI --seed 1

# 运行游戏（随机种子）
swift run GameCLI

# 运行测试（从项目根目录执行）
swift test                               # 运行全量 XCTest (~2秒)

# 可选：先验证 release 也能编译（CI 会同时 build debug + release）
swift build -c release
```

## 开发规范

### Cursor AI 编译测试规范

**重要**：在 Cursor AI 中运行编译和测试时，**必须使用后台运行模式**：

```swift
// ✅ 正确：使用 is_background: true
run_terminal_cmd(command: "swift build", is_background: true)

// ❌ 错误：前台运行可能导致超时或阻塞
run_terminal_cmd(command: "swift build", is_background: false)
```

原因：
- 避免长时间运行导致超时
- 防止交互式命令阻塞
- 测试脚本可能产生大量输出

### 调试工具

对于 Swift PM 项目的调试：

1. **LLDB 调试**：`swift build && lldb .build/debug/GameCLI`
2. **Xcode 调试**：`swift package generate-xcodeproj`（可使用 Instruments 分析内存）
3. **打印调试**：通过 `BattleEvent` 事件系统追踪状态变化

### 架构实现说明（协议驱动开发）

- 核心系统采用**协议驱动 + 注册表**的扩展方式：`CardDefinition/StatusDefinition/EnemyDefinition/RelicDefinition` + `*Registry` + 强类型 `*ID`
- `BattleEngine` 统一执行 `BattleEffect` 管线（新增内容尽量只新增 Definition + 注册，避免在引擎里写 switch）
- CLI 展示层（GameCLI）从 Registry 读取 `name/rulesText/icon` 渲染，避免硬编码分支

---

## 游戏规则

### 冒险流程

- 每次运行会生成一张 15 层的分支地图（Act 1），节点类型包含：开始、普通战斗、精英战斗、休息、商店、Boss。
- 玩家在房间之间选择路线，HP / 卡组 / 遗物 会在整次冒险过程中保持。
- 休息节点会回复 30% 最大生命；击败 Boss 后视为通关。

### 战斗目标

击败敌人（将敌人 HP 降为 0）即为胜利，玩家 HP 降为 0 则失败。

### 回合流程

```
回合开始
├── 能量恢复至 3
├── 玩家格挡清零
├── 抽 5 张牌
└── 显示敌人意图

玩家阶段
├── 选择打出手牌（消耗能量）
├── 或选择结束回合
└── 重复直到结束回合

回合结束
├── 弃掉所有手牌
├── 敌人执行行动
└── 进入下一回合
```

### 卡牌系统

| 卡牌 | 费用 | 效果 |
|------|------|------|
| Strike | 1 能量 | 造成 6 伤害 |
| Defend | 1 能量 | 获得 5 格挡 |
| Bash | 2 能量 | 造成 8 伤害，给予易伤 2 |
| Pommel Strike | 1 能量 | 造成 9 伤害，抽 1 张牌 |
| Shrug It Off | 1 能量 | 获得 8 格挡，抽 1 张牌 |
| Inflame | 1 能量 | 获得 2 力量 |
| Clothesline | 2 能量 | 造成 12 伤害，给予虚弱 2 |

初始牌组（13 张）：
- Strike × 4
- Defend × 4
- Bash × 1
- Pommel Strike × 1
- Shrug It Off × 1
- Inflame × 1
- Clothesline × 1

### 牌堆机制

- **抽牌堆（Draw Pile）**：每回合从这里抽牌
- **手牌（Hand）**：当前可使用的卡牌
- **弃牌堆（Discard Pile）**：用过的牌进入这里
- **洗牌**：抽牌堆空时，弃牌堆洗回抽牌堆

### 伤害与格挡

```
伤害结算顺序：
1. 力量加成：伤害 + 力量值
2. 虚弱减伤：伤害 × 0.75（向下取整）
3. 易伤增伤：伤害 × 1.5（向下取整）
4. 伤害先被格挡吸收
5. 超出格挡的部分扣除 HP
6. 格挡每回合开始时清零
```

示例：
- 玩家有 5 格挡，受到 7 伤害
- 5 格挡被消耗，实际受到 2 点 HP 伤害

### 状态效果

| 效果 | 说明 | 持续 |
|------|------|------|
| 易伤（Vulnerable） | 受到伤害 +50% | 每回合 -1 |
| 虚弱（Weak） | 造成伤害 -25% | 每回合 -1 |
| 脆弱（Frail） | 获得格挡 -25% | 每回合 -1 |
| 中毒（Poison） | 回合结束造成等量伤害，再 -1 层 | 递减 |
| 力量（Strength） | 攻击伤害 +N | 永久 |
| 敏捷（Dexterity） | 获得格挡 +N | 永久 |

---

## 商店与金币

### 起始金币

- 冒险开始时拥有 **99 金币**。

### 商店库存

- 商店会提供 **3 张可购买卡牌**（来自非起始卡池），并提供一次 **删牌服务**。

### 价格规则

- 买卡价格（按稀有度）：
  - 起始：30 金币（当前不会出现在商店）
  - 普通：45 金币
  - 罕见：75 金币
  - 稀有：150 金币
- 删牌服务：75 金币

---

## 数值设定

### 玩家属性

| 属性 | 数值 |
|------|------|
| 初始 HP | 80 |
| 每回合能量 | 3 |
| 每回合抽牌 | 5 |

### 敌人系统

游戏包含多种敌人，每种敌人有独特的 AI 行为：

| 敌人 | HP范围 | 基础攻击 | 特殊行为 |
|------|--------|---------|----------|
| 下颚虫 | 40-44 | 11 | 嚎叫(+3力量)、猛扑 |
| 信徒 | 48-54 | 6 | 第一回合念咒(+3力量) |
| 绿虱子 | 11-17 | 6 | 卷曲(+3力量) |
| 红虱子 | 10-15 | 6 | 卷曲(+3力量) |
| 酸液史莱姆 | 28-32 | 10 | 涂抹(施加虚弱) |

敌人通过 `EnemyPool` 随机选择，每种敌人有独立的 AI 决策逻辑。

---

## 操作指南

### 主菜单

| 输入 | 操作 |
|------|------|
| `1` | 🗺️ 开始冒险 / 🔄 继续上次冒险（有存档时） |
| `2` | 🗺️ 开始新冒险（有存档时） / ⚙️ 设置 / 战绩（无存档时） |
| `3` | ⚙️ 设置 / 战绩（有存档时） / 🚪 退出游戏（无存档时） |
| `4` | 🚪 退出游戏（有存档时） |

### 地图界面

| 输入 | 操作 |
|------|------|
| `1-N` | 选择可进入的节点 |
| `q` | 返回主菜单 |

### 战斗中

| 输入 | 操作 |
|------|------|
| `1` ~ `n` | 打出第 n 张手牌 |
| `0` | 结束回合 |
| `h` | 显示帮助 |
| `l` | 展开/折叠事件日志 |
| `q` | 返回主菜单 |

### 界面说明

```
┌─────────────────────────────────────┐
│ 👹 下颚虫: ❤️ 42/42 💔易伤2          │  ← 敌人状态+状态效果
├─────────────────────────────────────┤
│ 🧑 铁甲战士: ❤️ 80/80 🛡️ 5 💪力量+2   │  ← 玩家状态+状态效果
│ 能量：⚡ 3/3                         │  ← 当前能量
├─────────────────────────────────────┤
│ 🃏 手牌：                            │
│     ● [1] Strike (1能量) - 造成6伤害 │  ← ● 表示可用
│     ○ [2] Bash (2能量) - 造成8伤害   │  ← ○ 表示能量不足
├─────────────────────────────────────┤
│ 📚 抽牌堆：5 | 🗑️ 弃牌堆：3           │  ← 牌堆信息
├─────────────────────────────────────┤
│ [按 l 展开事件日志]                   │  ← 默认隐藏
└─────────────────────────────────────┘
```

---

## 命令行参数

| 参数 | 说明 |
|------|------|
| `--seed N` | 固定随机种子（可复现） |
| `--history` / `-H` | 查看历史战绩 |
| `--stats` / `-S` | 查看详细统计 |

```bash
# 使用固定种子（可复现）
swift run GameCLI --seed 42

# 查看历史战绩
swift run GameCLI --history

# 查看统计数据
swift run GameCLI --stats
```

---

## 战绩系统

战斗结束后自动记录：
- 胜负结果、回合数
- 使用卡牌统计
- 伤害/格挡统计

数据存储位置：
- **macOS**: `~/Library/Application Support/Salu/battle_history.json`
- **Linux**: `~/.salu/battle_history.json`
- **Windows**: `%LOCALAPPDATA%\Salu\battle_history.json`

---

## 存档系统

冒险模式会在**每个节点完成后自动保存**，主菜单会在检测到存档时显示“继续上次冒险”入口。

数据存储位置：
- **macOS**: `~/Library/Application Support/Salu/run_save.json`
- **Linux**: `~/.salu/run_save.json`
- **Windows**: `%LOCALAPPDATA%\Salu\run_save.json`

---

## 未来扩展计划

### ~~Phase 1：新卡牌~~ ✅ 已完成

| 卡牌 | 费用 | 效果 | 状态 |
|------|------|------|------|
| Bash | 2 能量 | 造成 8 伤害，给予易伤 2 | ✅ |
| Pommel Strike | 1 能量 | 造成 9 伤害，抽 1 张牌 | ✅ |
| Shrug It Off | 1 能量 | 获得 8 格挡，抽 1 张牌 | ✅ |

### ~~Phase 2：状态效果~~ ✅ 已完成

| 效果 | 说明 | 状态 |
|------|------|------|
| Vulnerable（易伤） | 受到伤害 +50% | ✅ Bash 施加 |
| Weak（虚弱） | 造成伤害 -25% | ✅ Clothesline 施加 |
| Strength（力量） | 攻击伤害 +N | ✅ Inflame 获得 |

### ~~Phase 3：敌人系统~~ ✅ 已完成

| 功能 | 说明 | 状态 |
|------|------|------|
| 5 种敌人 | 下颚虫、信徒、绿虱子、红虱子、酸液史莱姆 | ✅ |
| 敌人 AI | 每种敌人有独特行为模式 | ✅ |
| 意图系统 | 动态显示敌人下一步行动 | ✅ |
| 敌人池 | Act1EnemyPool 随机选择敌人 | ✅ |

### ~~Phase 4：地图程序生成~~ ✅ 已完成

| 功能 | 说明 | 状态 |
|------|------|------|
| 分支地图 | 15层分支节点，杀戮尖塔风格路径选择 | ✅ |
| 休息节点 | 恢复30%最大HP | ✅ |
| Boss 节点 | 击败后冒险胜利 | ✅ |
| 生命值保持 | 连续战斗间HP保持 | ✅ |
| 冒险模式 | 完整地图冒险流程 | ✅ |
| 地图显示 | [✓]已完成/[黄色]可选/[灰色]不可选 | ✅ |

### Phase 5：更多内容（下一阶段）

- 奖励系统（战斗后3选1卡牌）
- 卡牌升级系统
- 事件系统
- 多敌人战斗（目标选择机制）
